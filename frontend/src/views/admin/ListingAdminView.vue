<template>
  <div class="listing-admin-view">
    <b-alert :show="alert.dismissCountDown"
             dismissible
             fade
             :variant="alert.variant"
             @dismissed="alert.dismissCountDown=0"
             @dismiss-count-down="countDownChanged"
             class="mt-4">
      <h4 class="alert-heading font-weight-bold">{{ alert.heading }}</h4>
      <hr>
      {{ alert.message }}
    </b-alert>
    <b-row class="my-4">
      <div class="col-12 col-md-8">
        <b-card header="Legg ut en ny stillingsannonse" class="h-100">
          <b-form @submit.prevent="handleSubmit">
            <b-row>
              <div class="col-12 col-md-6">
                <b-form-group label="Stillingstittel" label-for="listing-name-input">
                  <b-form-input v-model="listing.name" id="listing-name-input" required placeholder="Velg en tittel" maxlength="100"></b-form-input>
                </b-form-group>
                <b-form-group label="Firmanavn" label-for="listing-company-input">
                  <b-form-input v-model="listing.company_name" id="listing-company-input" required placeholder="Skriv inn firmanavn" ></b-form-input>
                </b-form-group>
                <b-form-group label="Stillingstype" label-for="listing-company-type">
                  <b-form-select v-model="listing.type" :options="listingTypes" id="listing-company-type" required></b-form-select>
                </b-form-group>
                <b-button type="submit" class="d-none d-md-block" size="md" variant="success">Opprett annonse</b-button>
              </div>
              <div class="col-12 col-md-6">
                <b-form-group label="Søknadsfrist" label-for="listing-deadline">
                  <datepicker v-model="deadlineDateTime" :typeable="true" :required="true" format="yyyy-MM-dd" placeholder="Trykk for å velge dato" :bootstrap-styling="true" :monday-first="true" id="listing-deadline"></datepicker>
                </b-form-group>
                <div class="d-flex">
                  <b-form-group class="flex-grow-1" label="Logo" label-for="listing-logo">
                    <b-form-file v-model="logoFile" placeholder="Velg et bilde" @input="uploadLogo"></b-form-file>
                  </b-form-group>
                  <div class="img-preview flex-grow-0" v-bind:class="{ 'show-preview': showImgPreview }">
                    <b-img center fluid :src="imgPreviewSrc"></b-img>
                  </div>
                </div>
              </div>
            </b-row>
            <b-button type="submit" class="d-block d-md-none" size="md" variant="success">Opprett annonse</b-button>
          </b-form>
        </b-card>
      </div>
      <div class="d-none d-md-block col-4">
        <b-jumbotron bg-variant="info" text-variant="white" :header="numListings + ''" lead="åpne stillingsannonser" class="h-100">
        </b-jumbotron>
      </div>
    </b-row>
    <b-row>
      <div class="col-12">
        <b-card header="Stillingsannonser">
          <b-table class="d-none d-md-table" hover :items="listings"></b-table>
          <b-table class="d-block d-md-none" stacked :items="listings"></b-table>
        </b-card>
      </div>
    </b-row>
  </div>
</template>

<script>
import Datepicker from 'vuejs-datepicker'
import axios from 'axios'
import { mapMutations } from 'vuex'
export default {
  name: 'ListingAdminView',
  components: {
    Datepicker
  },
  data: function () {
    return {
      listing: {
        company_name: '',
        name: '',
        deadline: '',
        logo_uri: '',
        type: null
      },
      logoFile: null,
      showImgPreview: false,
      imgPreviewSrc: '',
      deadlineDateTime: null,
      alert: {
        dismissSecs: 5,
        dismissCountDown: 0,
        variant: 'info',
        heading: '',
        message: ''
      },
      listingTypes: [{value: null, text: 'Velg en stillingstype'}]
    }
  },
  computed: {
    listings: function () {
      return this.$store.state.listings.all
    },
    numListings: function () {
      return this.listings.length
    }
  },
  methods: {
    handleSubmit: function () {
      this.$data.listing.deadline = this.$data.deadlineDateTime.toISOString().split('T')[0]
      axios.post('http://127.0.0.1:8000/api/listing/', this.$data.listing).then((response) => {
        this.showAlert('success', 'Suksess!', 'Stillingsannonsen ble opprettet.')
        this['listings/addListing'](response.data)
        this.$data.listing = {company_name: '', name: '', deadline: '', logo_uri: '', type: null}
        this.$data.deadlineDateTime = null
      }).catch((e) => {
        this.showAlert('danger',
          'Error ' + e.response.status + ' ' + e.response.statusText,
          'Stillingsannonsen ble ikke opprettet.')
      })
    },
    countDownChanged: function (dismissCountDown) {
      this.alert.dismissCountDown = dismissCountDown
    },
    showAlert: function (variant, heading, message) {
      this.alert.variant = variant
      this.alert.heading = heading
      this.alert.message = message
      this.alert.dismissCountDown = this.alert.dismissSecs
    },
    uploadLogo: function () {
      this.$data.showImgPreview = false
      this.$data.imgPreviewSrc = ''
      if (this.$data.logoFile === undefined) {
        return
      }
      let formData = new FormData()
      formData.append('file', this.$data.logoFile)
      axios.post('http://127.0.0.1:9000/upload/image', formData).then((response) => {
        this.$data.imgPreviewSrc = 'http://127.0.0.1:9000/' + response.data
        this.$data.listing.logo_uri = response.data
        setTimeout(() => {
          this.$data.showImgPreview = true
        }, 30) // The image src can't be set at the same time as the img opacity or it will lose its transition
      }).catch((e) => {
        this.showAlert('error',
          'Error ' + e.response.status + ' ' + e.response.statusText,
          'Bildeopplastning feilet, prøv igjen. Kontakt IT om problemet vedvarer.')
        this.$data.showImgPreview = false
        this.$data.imgPreviewSrc = ''
      })
    },
    ...mapMutations(['listings/addListing'])
  },
  beforeCreate: function () {
    axios.options('http://127.0.0.1:8000/api/listing/').then((response) => {
      this.$data.listingTypes = this.$data.listingTypes.concat(response.data.actions.POST.type.choices.map(
        option => ({value: option.value, text: option.display_name})
      ))
    }).catch((e) => {
      this.showAlert('error',
        'Error ' + e.response.status + ' ' + e.response.statusText,
        'Kunne ikke lese skjema fra tjeneren. Prøv å laste siden på nytt.')
    })
  }
}
</script>

<style scoped lang="scss">
.img-preview {
  width: 0;
  height: 100px;
  transition: width 0.4s;
  border-radius: 2px;
  margin:0;
  &.show-preview {
    width: 100px;
    margin-left: 1.2rem;
    img {
      opacity: 1 !important;
    }
  }
  img {
    opacity: 0 !important;
    transition: opacity 0.4s 0.4s;
  }
}
</style>
