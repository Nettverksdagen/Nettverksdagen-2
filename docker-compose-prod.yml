services:
  postgres:
    image: postgres
    restart: unless-stopped
    container_name: postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

  api:
    build: ./api
    command: "./django-prod-entrypoint.sh"
    depends_on:
      - postgres
    restart: unless-stopped
    environment:
      - DJANGO_SETTINGS_MODULE=nvdnew.settings.prod

  frontend:
    build:
      context: ./frontend
      target: builder
      args:
        - DOMAIN=${DOMAIN}
    volumes:
      - frontend-files:/frontend/dist
    command: ["echo", "Successfully created static frontend files"] # No operation

  fileserver:
    build: ./fileserver
    command: ["./main"]
    restart: unless-stopped
    volumes:
      - ./fileserver/uploads:/root/uploads

  nginx:
    image: linuxserver/swag
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      - PUID=1002
      - GUID=1003
      - EMAIL=it@${DOMAIN}
      - URL=${DOMAIN}
      - SUBDOMAINS=${SUBDOMAINS}
      - TZ=Europe/Oslo
      - VALIDATION=http
      #- STAGING=true # Uncomment this when testing
    depends_on:
      - api
      - fileserver
    volumes:
      - ./nginx/config:/config # Todo: Can this volume include the below?
      - frontend-files:/frontend

volumes:
  frontend-files:
